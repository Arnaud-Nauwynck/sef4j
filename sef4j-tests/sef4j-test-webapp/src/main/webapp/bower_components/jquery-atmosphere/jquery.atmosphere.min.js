/*
 * Copyright 2014 Jeanfrancois Arcand
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * Atmosphere.js
 * https://github.com/Atmosphere/atmosphere-javascript
 * 
 * Requires 
 * - jQuery 2.0.3 http://jquery.com/
 * 
 * API reference
 * https://github.com/Atmosphere/atmosphere/wiki/jQuery.atmosphere.js-API
 * 
 * Highly inspired by 
 * - Portal by Donghwan Kim http://flowersinthesand.github.io/portal/
 */
(function(d){"function"===typeof define&&define.amd?define(["jquery"],d):d(jQuery)})(function(d){d(window).bind("unload.atmosphere",function(){d.atmosphere.unsubscribe()});d(window).bind("offline",function(){for(var k=[].concat(d.atmosphere.requests),l=0;l<k.length;l++){var g=k[l];g.close();clearTimeout(g.response.request.id);g.heartbeatTimer&&clearTimeout(g.heartbeatTimer)}});d(window).bind("online",function(){if(0<d.atmosphere.requests.length)for(var k=0;k<d.atmosphere.requests.length;k++)d.atmosphere.requests[k].execute()});
d(window).keypress(function(d){27===d.keyCode&&d.preventDefault()});var ga=function(d){for(var l,g=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,s={};l=g.exec(d);)s[l[1]]=l[2];return s};d.atmosphere={version:"2.2.5-jquery",uuid:0,requests:[],callbacks:[],onError:function(d){},onClose:function(d){},onOpen:function(d){},onMessage:function(d){},onReconnect:function(d,l){},onMessagePublished:function(d){},onTransportFailure:function(d,l){},onLocalMessage:function(d){},onClientTimeout:function(d){},onFailureToReconnect:function(d,
l){},WebsocketApiAdapter:function(d){var l,g;d.onMessage=function(d){g.onmessage({data:d.responseBody})};d.onMessagePublished=function(d){g.onmessage({data:d.responseBody})};d.onOpen=function(d){g.onopen(d)};g={close:function(){l.close()},send:function(d){l.push(d)},onmessage:function(d){},onopen:function(d){},onclose:function(d){},onerror:function(d){}};l=new $.atmosphere.subscribe(d);return g},AtmosphereRequest:function(k){function l(c){q();aa=!0;G=!1;y=0;C=K=z=p=null;e=d.extend(e,c);e.mrequest=
e.reconnect;e.reconnect||(e.reconnect=!0)}function g(){if(e.shared){w=s(e);if(null!=w&&("debug"===e.logLevel&&d.atmosphere.debug("Storage service available. All communication will be local"),w.open(e)))return;"debug"===e.logLevel&&d.atmosphere.debug("No Storage service available.");w=null}e.firstMessage=0==d.atmosphere.uuid?!0:!1;e.isOpen=!1;e.ctime=d.now();0===e.uuid&&(e.uuid=d.atmosphere.uuid);e.closedByClientTimeout=!1;"websocket"!==e.transport&&"sse"!==e.transport?W(e):"websocket"===e.transport?
null!=e.webSocketImpl||window.WebSocket||window.MozWebSocket?n(!1):L("Websocket is not supported, using request.fallbackTransport ("+e.fallbackTransport+")"):"sse"===e.transport&&(window.EventSource?u(!1):L("Server Side Events(SSE) is not supported, using request.fallbackTransport ("+e.fallbackTransport+")"))}function s(c){function a(a){a=d.parseJSON(a);var h=a.data;if("c"===a.target)switch(a.type){case "open":m("opening","local",e);break;case "close":ba||(ba=!0,"aborted"===h.reason?O():h.heir===
H?g():setTimeout(function(){g()},100));break;case "message":I(h,"messageReceived",200,c.transport);break;case "localMessage":ha(h)}}function f(){var a=(new RegExp("(?:^|; )("+encodeURIComponent(r)+")=([^;]*)")).exec(document.cookie);if(a)return d.parseJSON(decodeURIComponent(a[2]))}var h,M,ba,r="atmosphere-"+c.url,k={storage:function(){if(d.atmosphere.supportStorage()){var e=window.localStorage,h=function(a){return d.parseJSON(e.getItem(r+"-"+a))},f=function(a,c){e.setItem(r+"-"+a,d.stringifyJSON(c))};
return{init:function(){f("children",h("children").concat([H]));d(window).on("storage.socket",function(c){c=c.originalEvent;c.key===r&&c.newValue&&a(c.newValue)});return h("opened")},signal:function(a,c){e.setItem(r,d.stringifyJSON({target:"p",type:a,data:c}))},close:function(){var a,e=h("children");d(window).off("storage.socket");e&&(a=d.inArray(c.id,e),-1<a&&(e.splice(a,1),f("children",e)))}}}},windowref:function(){var c=window.open("",r.replace(/\W/g,""));if(c&&!c.closed&&c.callbacks)return{init:function(){c.callbacks.push(a);
c.children.push(H);return c.opened},signal:function(a,e){!c.closed&&c.fire&&c.fire(d.stringifyJSON({target:"p",type:a,data:e}))},close:function(){if(!ba){var e=c.callbacks,h=d.inArray(a,e);-1<h&&e.splice(h,1);e=c.children;h=d.inArray(H,e);-1<h&&e.splice(h,1)}}}}};if((h=f())&&!(1E3<d.now()-h.ts)&&(M=k.storage()||k.windowref()))return{open:function(){var e;X=setInterval(function(){var c=h;(h=f())&&c.ts!==h.ts||a(d.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:c.heir}}))},1E3);(e=
M.init())&&setTimeout(function(){m("opening","local",c)},50);return e},send:function(a){M.signal("send",a)},localSend:function(a){M.signal("localSend",d.stringifyJSON({id:H,event:a}))},close:function(){G||(clearInterval(X),M.signal("close"),M.close())}}}function P(){function c(a){a=d.parseJSON(a);var c=a.data;if("p"===a.target)switch(a.type){case "send":Q(c);break;case "localSend":ha(c);break;case "close":O()}}function a(){document.cookie=ca+"="+encodeURIComponent(d.stringifyJSON({ts:d.now()+1,heir:(f.get("children")||
[])[0]}))+"; path=/"}var f,h="atmosphere-"+e.url,g={storage:function(){if(d.atmosphere.supportStorage()){var a=window.localStorage;return{init:function(){d(window).on("storage.socket",function(a){a=a.originalEvent;a.key===h&&a.newValue&&c(a.newValue)})},signal:function(c,e){a.setItem(h,d.stringifyJSON({target:"c",type:c,data:e}))},get:function(c){return d.parseJSON(a.getItem(h+"-"+c))},set:function(c,e){a.setItem(h+"-"+c,d.stringifyJSON(e))},close:function(){d(window).off("storage.socket");a.removeItem(h);
a.removeItem(h+"-opened");a.removeItem(h+"-children")}}}},windowref:function(){var a=h.replace(/\W/g,""),e=(d('iframe[name="'+a+'"]')[0]||d('<iframe name="'+a+'" />').hide().appendTo("body")[0]).contentWindow;return{init:function(){e.callbacks=[c];e.fire=function(a){var c;for(c=0;c<e.callbacks.length;c++)e.callbacks[c](a)}},signal:function(a,c){!e.closed&&e.fire&&e.fire(d.stringifyJSON({target:"c",type:a,data:c}))},get:function(a){return e.closed?null:e[a]},set:function(a,c){e.closed||(e[a]=c)},close:function(){}}}};
R=function(a){f.signal("message",a)};f=g.storage()||g.windowref();f.init();"debug"===e.logLevel&&d.atmosphere.debug("Installed StorageService "+f);f.set("children",[]);null==f.get("opened")||f.get("opened")||f.set("opened",!1);ca=encodeURIComponent(h);a();X=setInterval(a,1E3);D=f}function m(c,a,d){e.shared&&"local"!==a&&P();null!=D&&D.set("opened",!0);d.close=function(){O()};0<y&&"re-connecting"===c?(d.isReopen=!0,ra(f)):null==f.error&&(f.request=d,d=f.state,f.state=c,c=f.transport,f.transport=a,
a=f.responseBody,x(),f.responseBody=a,f.state=d,f.transport=c)}function ia(c){c.transport="jsonp";var a=e;null!=c&&"undefined"!==typeof c&&(a=c);c=a.url;null!=a.dispatchUrl&&(c+=a.dispatchUrl);var A=a.data;a.attachHeadersAsQueryString&&(c=J(a),""!==A&&(c+="&X-Atmosphere-Post-Body="+encodeURIComponent(A)),A="");v=d.ajax({url:c,type:a.method,dataType:"jsonp",error:function(c,e,d){f.error=!0;a.openId&&clearTimeout(a.openId);a.heartbeatTimer&&clearTimeout(a.heartbeatTimer);a.reconnect&&y++<a.maxReconnectOnClose?
(m("re-connecting",a.transport,a),B(v,a,a.reconnectInterval),a.openId=setTimeout(function(){S(a)},a.reconnectInterval+1E3)):t(c.status,d)},jsonp:"jsonpTransport",success:function(c){if(a.reconnect)if(-1===a.maxRequest||a.requestCount++<a.maxRequest){Y(v,a);E(a);a.executeCallbackBeforeReconnect||B(v,a,a.pollingInterval);c=c.message;if(null!=c&&"string"!==typeof c)try{c=d.stringifyJSON(c)}catch(A){}F(c,a,f)||I(f.responseBody,"messageReceived",200,a.transport);a.executeCallbackBeforeReconnect&&B(v,a,
a.pollingInterval)}else d.atmosphere.log(e.logLevel,["JSONP reconnect maximum try reached "+e.requestCount]),t(0,"maxRequest reached")},data:a.data,beforeSend:function(c){da(c,a,!1)}})}function sa(c){var a=e;null!=c&&"undefined"!==typeof c&&(a=c);c=a.url;null!=a.dispatchUrl&&(c+=a.dispatchUrl);var A=a.data;a.attachHeadersAsQueryString&&(c=J(a),""!==A&&(c+="&X-Atmosphere-Post-Body="+encodeURIComponent(A)),A="");v=d.ajax({url:c,type:a.method,error:function(c,e,d){f.error=!0;300>c.status?B(v,a):t(c.status,
d)},success:function(c,A,g){a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest?(a.executeCallbackBeforeReconnect||B(v,a,a.pollingInterval),F(c,a,f)||I(f.responseBody,"messageReceived",200,a.transport),a.executeCallbackBeforeReconnect&&B(v,a,a.pollingInterval)):(d.atmosphere.log(e.logLevel,["AJAX reconnect maximum try reached "+e.requestCount]),t(0,"maxRequest reached")))},beforeSend:function(c){da(c,a,!1)},crossDomain:a.enableXDR,async:"undefined"!==typeof a.async?a.async:!0})}function ta(c){return null!=
e.webSocketImpl?e.webSocketImpl:window.WebSocket?new WebSocket(c):new MozWebSocket(c)}function N(){var c=J(e);return decodeURI(d('<a href="'+c+'"/>')[0].href.replace(/^http/,"ws"))}function u(c){f.transport="sse";var a=J(e);"debug"===e.logLevel&&(d.atmosphere.debug("Invoking executeSSE"),d.atmosphere.debug("Using URL: "+a));if(c&&!e.reconnect)null!=z&&q();else{try{z=new EventSource(a,{withCredentials:e.withCredentials})}catch(A){t(0,A);L("SSE failed. Downgrading to fallback transport and resending");
return}0<e.connectTimeout&&(e.id=setTimeout(function(){c||q()},e.connectTimeout));z.onopen=function(a){E(e);"debug"===e.logLevel&&d.atmosphere.debug("SSE successfully opened");e.enableProtocol?e.isReopen&&(e.isReopen=!1,m("re-opening",e.transport,e)):c?m("re-opening","sse",e):m("opening","sse",e);c=!0;"POST"===e.method&&(f.state="messageReceived",z.send(e.data))};z.onmessage=function(a){E(e);e.enableXDR||a.origin===window.location.protocol+"//"+window.location.host?(f.state="messageReceived",f.status=
200,a=a.data,F(a,e,f)||(x(),f.responseBody="",f.messages=[])):d.atmosphere.log(e.logLevel,["Origin was not "+window.location.protocol+"//"+window.location.host])};z.onerror=function(a){clearTimeout(e.id);e.heartbeatTimer&&clearTimeout(e.heartbeatTimer);f.closedByClientTimeout||((T(c),q(),G)?d.atmosphere.log(e.logLevel,["SSE closed normally"]):c?e.reconnect&&"sse"===f.transport&&(y++<e.maxReconnectOnClose?(m("re-connecting",e.transport,e),0<e.reconnectInterval?e.reconnectId=setTimeout(function(){u(!0)},
e.reconnectInterval):u(!0),f.responseBody="",f.messages=[]):(d.atmosphere.log(e.logLevel,["SSE reconnect maximum try reached "+y]),t(0,"maxReconnectOnClose reached"))):L("SSE failed. Downgrading to fallback transport and resending"))}}}function n(c){f.transport="websocket";var a=N(e.url);"debug"===e.logLevel&&(d.atmosphere.debug("Invoking executeWebSocket"),d.atmosphere.debug("Using URL: "+a));if(c&&!e.reconnect)null!=p&&q();else if(p=ta(a),null!=e.webSocketBinaryType&&(p.binaryType=e.webSocketBinaryType),
0<e.connectTimeout&&(e.id=setTimeout(function(){if(!c){p.onclose({code:1002,reason:"",wasClean:!1});try{q()}catch(a){}}},e.connectTimeout)),p.onopen=function(a){E(e);"debug"===e.logLevel&&d.atmosphere.debug("Websocket successfully opened");a=c;null!=p&&(p.canSendMessage=!0);e.enableProtocol||(c=!0,a?m("re-opening","websocket",e):m("opening","websocket",e));null!=p&&"POST"===e.method&&(f.state="messageReceived",p.send(e.data))},p.onmessage=function(a){E(e);e.enableProtocol&&(c=!0);f.state="messageReceived";
f.status=200;a=a.data;"string"===typeof a?F(a,e,f)||(x(),f.responseBody="",f.messages=[]):(a=ja(e,a),""!==a&&(f.responseBody=a,x(),f.responseBody=null))},p.onerror=function(a){clearTimeout(e.id);e.heartbeatTimer&&clearTimeout(e.heartbeatTimer)},p.onclose=function(a){if("closed"!==f.state){clearTimeout(e.id);var h=a.reason;if(""===h)switch(a.code){case 1E3:h="Normal closure; the connection successfully completed whatever purpose for which it was created.";break;case 1001:h="The endpoint is going away, either because of a server failure or because the browser is navigating away from the page that opened the connection.";
break;case 1002:h="The endpoint is terminating the connection due to a protocol error.";break;case 1003:h="The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data).";break;case 1004:h="The endpoint is terminating the connection because a data frame was received that is too large.";break;case 1005:h="Unknown: no status code was provided even though one was expected.";break;case 1006:h="Connection was closed abnormally (that is, with no close frame being sent)."}"warn"===
e.logLevel&&(d.atmosphere.warn("Websocket closed, reason: "+h),d.atmosphere.warn("Websocket closed, wasClean: "+a.wasClean));f.closedByClientTimeout||((T(c),f.state="closed",G)?d.atmosphere.log(e.logLevel,["Websocket closed normally"]):c?e.reconnect&&"websocket"===f.transport&&1001!==a.code&&(q(),y++<e.maxReconnectOnClose?(m("re-connecting",e.transport,e),0<e.reconnectInterval?e.reconnectId=setTimeout(function(){f.responseBody="";f.messages=[];n(!0)},e.reconnectInterval):(f.responseBody="",f.messages=
[],n(!0))):(d.atmosphere.log(e.logLevel,["Websocket reconnect maximum try reached "+e.requestCount]),"warn"===e.logLevel&&d.atmosphere.warn("Websocket error, reason: "+a.reason),t(0,"maxReconnectOnClose reached"))):L("Websocket failed. Downgrading to Comet and resending"))}},-1<navigator.userAgent.toLowerCase().indexOf("android")&&void 0===p.url)p.onclose({reason:"Android 4.1 does not support websockets.",wasClean:!1})}function ja(c,a){var f=a;if("polling"===c.transport)return f;if(0!==d.trim(a).length&&
c.enableProtocol&&c.firstMessage){var h=c.trackMessageLength?1:0,g=a.split(c.messageDelimiter);if(g.length<=h+1)return f;c.firstMessage=!1;c.uuid=d.trim(g[h]);g.length<=h+2&&d.atmosphere.log("error",["Protocol data not sent by the server. If you enable protocol on client side, be sure to install JavascriptProtocol interceptor on server side.Also note that atmosphere-runtime 2.2+ should be used."]);var k=parseInt(d.trim(g[h+1]),10);ea=g[h+2];if(!isNaN(k)&&0<k){var l=function(){Q(ea);c.heartbeatTimer=
setTimeout(l,k)};c.heartbeatTimer=setTimeout(l,k)}b=!1;"long-polling"!==c.transport&&S(c);d.atmosphere.uuid=c.uuid;f="";h=c.trackMessageLength?4:3;if(g.length>h+1)for(;h<g.length;h++)f+=g[h],h+1!==g.length&&(f+=c.messageDelimiter);0!==c.ackInterval&&setTimeout(function(){Q("...ACK...")},c.ackInterval)}else c.enableProtocol&&c.firstMessage&&d.browser.msie&&10>+d.browser.version.split(".")[0]?d.atmosphere.log(e.logLevel,["Receiving unexpected data from IE"]):S(c);return f}function E(c){c.timedOut=!1;
clearTimeout(c.id);0<c.timeout&&"polling"!==c.transport&&(c.id=setTimeout(function(){c.timedOut=!0;f.closedByClientTimeout=!0;f.state="closedByClient";f.responseBody="";f.status=408;f.messages=[];x();fa();q()},c.timeout))}function t(c,a){q();clearTimeout(e.id);f.state="error";f.reasonPhrase=a;f.responseBody="";f.status=c;f.messages=[];x()}function F(c,a,e){c=ja(a,c);if(0===c.length)return!0;e.responseBody=c;if(a.trackMessageLength){c=e.partialMessage+c;for(var d=[],f=c.indexOf(a.messageDelimiter);-1!==
f;){var g=c.substring(0,f),k=parseInt(g,10);if(isNaN(k))throw'message length "'+g+'" is not a number';f+=a.messageDelimiter.length;f+k>c.length?f=-1:(d.push(c.substring(f,f+k)),c=c.substring(f+k,c.length),f=c.indexOf(a.messageDelimiter))}e.partialMessage=c;if(0!==d.length)e.responseBody=d.join(a.messageDelimiter),e.messages=d;else return e.responseBody="",e.messages=[],!0}else e.responseBody=c;return!1}function L(c){d.atmosphere.log(e.logLevel,[c]);if("undefined"!==typeof e.onTransportFailure)e.onTransportFailure(c,
e);else if("undefined"!==typeof d.atmosphere.onTransportFailure)d.atmosphere.onTransportFailure(c,e);e.transport=e.fallbackTransport;c=-1===e.connectTimeout?0:e.connectTimeout;e.reconnect&&"none"!==e.transport||null==e.transport?(e.method=e.fallbackMethod,f.transport=e.fallbackTransport,e.fallbackTransport="none",0<c?e.reconnectId=setTimeout(function(){g()},c):g()):t(500,"Unable to reconnect with fallback transport")}function J(c,a){var g=e;null!=c&&"undefined"!==typeof c&&(g=c);null==a&&(a=g.url);
if(!g.attachHeadersAsQueryString||-1!==a.indexOf("X-Atmosphere-Framework"))return a;a+=-1!==a.indexOf("?")?"&":"?";a+="X-Atmosphere-tracking-id="+g.uuid;a+="&X-Atmosphere-Framework="+d.atmosphere.version;a+="&X-Atmosphere-Transport="+g.transport;g.trackMessageLength&&(a+="&X-Atmosphere-TrackMessageSize=true");null!==g.heartbeat&&null!==g.heartbeat.server&&(a+="&X-Heartbeat-Server="+g.heartbeat.server);""!==g.contentType&&(a+="&Content-Type="+("websocket"===g.transport?g.contentType:encodeURIComponent(g.contentType)));
g.enableProtocol&&(a+="&X-atmo-protocol=true");d.each(g.headers,function(e,k){var l=d.isFunction(k)?k.call(this,g,c,f):k;null!=l&&(a+="&"+encodeURIComponent(e)+"="+encodeURIComponent(l))});return a}function S(c){c.isOpen?c.isReopen&&(c.isReopen=!1,m("re-opening",c.transport,c)):(c.isOpen=!0,m("opening",c.transport,c))}function W(c){var a=e;if(null!=c||"undefined"!==typeof c)a=c;a.lastIndex=0;a.readyState=0;if("jsonp"===a.transport||a.enableXDR&&d.atmosphere.checkCORSSupport())ia(a);else if("ajax"===
a.transport)sa(c);else{if(d.browser.msie&&10>+d.browser.version.split(".")[0]){if("streaming"===a.transport){a.enableXDR&&window.XDomainRequest?U(a):V(a);return}if(a.enableXDR&&window.XDomainRequest){U(a);return}}var g=function(){a.lastIndex=0;a.reconnect&&y++<a.maxReconnectOnClose?(f.ffTryingReconnect=!0,m("re-connecting",c.transport,c),B(h,a,c.reconnectInterval)):t(0,"maxReconnectOnClose reached")};if(a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest)){var h=d.ajaxSettings.xhr();h.hasData=
!1;da(h,a,!0);a.suspend&&(K=h);"polling"!==a.transport&&(f.transport=a.transport,h.onabort=function(){T(!0)},h.onerror=function(){f.error=!0;f.ffTryingReconnect=!0;try{f.status=XMLHttpRequest.status}catch(a){f.status=500}f.status||(f.status=500);f.errorHandled||(q(),g())});h.onreadystatechange=function(){if(!G){f.error=null;var k=!1,l=!1;if("streaming"===a.transport&&2<a.readyState&&4===h.readyState)q(),g();else{a.readyState=h.readyState;"streaming"===a.transport&&3<=h.readyState?l=!0:"long-polling"===
a.transport&&4===h.readyState&&(l=!0);E(e);if("polling"!==a.transport){var r=200;4===h.readyState&&(r=1E3<h.status?0:h.status);if(!a.reconnectOnServerError&&300<=r&&600>r){t(r,h.statusText);return}if(300<=r||0===r){f.errorHandled=!0;q();g();return}a.enableProtocol&&c.firstMessage||2!==h.readyState||(d.browser.mozilla&&f.ffTryingReconnect?(f.ffTryingReconnect=!1,setTimeout(function(){f.ffTryingReconnect||S(a)},500)):S(a))}else 4===h.readyState&&(l=!0);if(l)if(l=h.responseText,0===d.trim(l).length&&
"long-polling"===a.transport)h.hasData?h.hasData=!1:B(h,a,a.pollingInterval);else{h.hasData=!0;Y(h,e);if("streaming"===a.transport)if(d.browser.opera)d.atmosphere.iterate(function(){if(500!==f.status&&h.responseText.length>a.lastIndex){try{f.status=h.status,f.headers=ga(h.getAllResponseHeaders()),Y(h,e)}catch(c){f.status=404}E(e);f.state="messageReceived";var d=h.responseText.substring(a.lastIndex);a.lastIndex=h.responseText.length;(k=F(d,a,f))||x();ka(h,a)&&la(h,a)}else if(400<f.status)return a.lastIndex=
h.responseText.length,!1},0);else{if(r=l.substring(a.lastIndex,l.length),k=F(r,a,f),a.lastIndex=l.length,k)return}else k=F(l,a,f);l=ka(h,a);try{f.status=h.status,f.headers=ga(h.getAllResponseHeaders()),Y(h,a)}catch(m){f.status=404}f.state=a.suspend?0===f.status?"closed":"messageReceived":"messagePublished";(r=!l&&"streaming"!==c.transport&&"polling"!==c.transport)&&!a.executeCallbackBeforeReconnect&&B(h,a,a.pollingInterval);0===f.responseBody.length||k||x();r&&a.executeCallbackBeforeReconnect&&B(h,
a,a.pollingInterval);l&&la(h,a)}}}};h.send(a.data);aa=!0}else"debug"===a.logLevel&&d.atmosphere.log(a.logLevel,["Max re-connection reached."]),t(0,"maxRequest reached")}}function la(c,a){O();G=!1;B(c,a,500)}function da(c,a,g){var h=a.url;null!=a.dispatchUrl&&"POST"===a.method&&(h+=a.dispatchUrl);h=J(a,h);h=d.atmosphere.prepareURL(h);g&&(c.open(a.method,h,!0),0<a.connectTimeout&&(a.id=setTimeout(function(){0===a.requestCount&&(q(),I("Connect timeout","closed",200,a.transport))},a.connectTimeout)));
e.withCredentials&&"websocket"!==e.transport&&"withCredentials"in c&&(c.withCredentials=!0);e.dropHeaders||(c.setRequestHeader("X-Atmosphere-Framework",d.atmosphere.version),c.setRequestHeader("X-Atmosphere-Transport",a.transport),null!==c.heartbeat&&null!==c.heartbeat.server&&c.setRequestHeader("X-Heartbeat-Server",c.heartbeat.server),a.trackMessageLength&&c.setRequestHeader("X-Atmosphere-TrackMessageSize","true"),c.setRequestHeader("X-Atmosphere-tracking-id",a.uuid),d.each(a.headers,function(e,
h){var k=d.isFunction(h)?h.call(this,c,a,g,f):h;null!=k&&c.setRequestHeader(e,k)}));""!==a.contentType&&c.setRequestHeader("Content-Type",a.contentType)}function B(c,a,d){if(a.reconnect||a.suspend&&aa){var h=0;1<c.readyState&&(h=1E3<c.status?0:c.status);f.status=0===h?204:h;f.reason=0===h?"Server resumed the connection or down.":"OK";clearTimeout(a.id);a.reconnectId&&(clearTimeout(a.reconnectId),delete a.reconnectId);0<d?setTimeout(function(){e.reconnectId=W(a)},d):W(a)}}function ra(c){c.state="re-connecting";
ma(c)}function U(c){"polling"!==c.transport?(C=na(c),C.open()):na(c).open()}function na(c){var a=e;null!=c&&"undefined"!==typeof c&&(a=c);var g=a.transport,h=0,k=new window.XDomainRequest,l=function(){"long-polling"===a.transport&&a.reconnect&&(-1===a.maxRequest||a.requestCount++<a.maxRequest)&&(k.status=200,m("re-connecting",c.transport,c),U(a))},r=a.rewriteURL||function(a){var c=/(?:^|;\s*)(JSESSIONID|PHPSESSID)=([^;]*)/.exec(document.cookie);switch(c&&c[1]){case "JSESSIONID":return a.replace(/;jsessionid=[^\?]*|(\?)|$/,
";jsessionid="+c[2]+"$1");case "PHPSESSID":return a.replace(/\?PHPSESSID=[^&]*&?|\?|$/,"?PHPSESSID="+c[2]+"&").replace(/&$/,"")}return a};k.onprogress=function(){clearTimeout(a.id);var c=k.responseText,c=c.substring(h);h+=c.length;if("polling"!==g){E(a);var e=F(c,a,f);if("long-polling"!==g||0!==d.trim(c).length)a.executeCallbackBeforeReconnect&&l(),e||I(f.responseBody,"messageReceived",200,g),a.executeCallbackBeforeReconnect||l()}};k.onerror=function(){"polling"!==a.transport&&(q(),y++<a.maxReconnectOnClose?
0<a.reconnectInterval?a.reconnectId=setTimeout(function(){m("re-connecting",c.transport,c);U(a)},a.reconnectInterval):(m("re-connecting",c.transport,c),U(a)):t(0,"maxReconnectOnClose reached"))};k.onload=function(){e.timedOut&&(e.timedOut=!1,q(),a.lastIndex=0,a.reconnect&&y++<a.maxReconnectOnClose?(m("re-connecting",c.transport,c),l()):t(0,"maxReconnectOnClose reached"))};return{open:function(){var c=a.url;null!=a.dispatchUrl&&(c+=a.dispatchUrl);c=J(a,c);k.open(a.method,r(c));"GET"===a.method?k.send():
k.send(a.data);0<a.connectTimeout&&(a.id=setTimeout(function(){0===a.requestCount&&(q(),I("Connect timeout","closed",200,a.transport))},a.connectTimeout))},close:function(){k.abort()}}}function V(c){C=ua(c);C.open()}function ua(c){var a=e;null!=c&&"undefined"!==typeof c&&(a=c);var g,h=new window.ActiveXObject("htmlfile");h.open();h.close();var k=a.url;null!=a.dispatchUrl&&(k+=a.dispatchUrl);"polling"!==a.transport&&(f.transport=a.transport);return{open:function(){var c=h.createElement("iframe");k=
J(a);""!==a.data&&(k+="&X-Atmosphere-Post-Body="+encodeURIComponent(a.data));k=d.atmosphere.prepareURL(k);c.src=k;h.body.appendChild(c);var l=c.contentDocument||c.contentWindow.document;g=d.atmosphere.iterate(function(){try{if(l.firstChild){if("complete"===l.readyState)try{d.noop(l.fileSize)}catch(c){return I("Connection Failure","error",500,a.transport),!1}var k=l.body?l.body.lastChild:l,n=function(){var a=k.cloneNode(!0);a.appendChild(l.createTextNode("."));a=a.innerText;return a=a.substring(0,
a.length-1)};if(!d.nodeName(k,"pre")){var p=l.head||l.getElementsByTagName("head")[0]||l.documentElement||l,q=l.createElement("script");q.text="document.write('<plaintext>')";p.insertBefore(q,p.firstChild);p.removeChild(q);k=l.body.lastChild}a.closed&&(a.isReopen=!0);g=d.atmosphere.iterate(function(){var c=n();if(c.length>a.lastIndex){E(e);f.status=200;f.error=null;k.innerText="";if(F(c,a,f))return"";I(f.responseBody,"messageReceived",200,a.transport)}a.lastIndex=0;if("complete"===l.readyState)return T(!0),
m("re-connecting",a.transport,a),0<a.reconnectInterval?a.reconnectId=setTimeout(function(){V(a)},a.reconnectInterval):V(a),!1},null);return!1}}catch(s){return f.error=!0,m("re-connecting",a.transport,a),y++<a.maxReconnectOnClose?0<a.reconnectInterval?a.reconnectId=setTimeout(function(){V(a)},a.reconnectInterval):V(a):t(0,"maxReconnectOnClose reached"),h.execCommand("Stop"),h.close(),!1}})},close:function(){g&&g();h.execCommand("Stop");T(!0)}}}function Q(c){null!=w?w.send(c):null!=K||null!=z?Z(c):
null!=C?e.enableXDR&&d.atmosphere.checkCORSSupport()?(c=oa(c),c.reconnect=!1,ia(c)):Z(c):null!=v?Z(c):null!=p?va(c):(t(0,"No suspended connection available"),d.atmosphere.error("No suspended connection available. Make sure atmosphere.subscribe has been called and request.onOpen invoked before invoking this method"))}function Z(c){c=oa(c);W(c)}function pa(c){var a=c;"object"===typeof a&&(a=c.data);return a}function oa(c){var a=pa(c),a={connected:!1,timeout:6E4,method:"POST",url:e.url,contentType:e.contentType,
headers:e.headers,reconnect:!0,callback:null,data:a,suspend:!1,maxRequest:-1,logLevel:"info",requestCount:0,withCredentials:e.withCredentials,transport:"polling",isOpen:!0,attachHeadersAsQueryString:!0,enableXDR:e.enableXDR,uuid:e.uuid,dispatchUrl:e.dispatchUrl,enableProtocol:!1,messageDelimiter:"|",trackMessageLength:e.trackMessageLength,maxReconnectOnClose:e.maxReconnectOnClose,heartbeatTimer:e.heartbeatTimer,heartbeat:e.heartbeat};"object"===typeof c&&(a=d.extend(a,c));return a}function va(c){var a=
d.atmosphere.isBinary(c)?c:pa(c),f;try{f=null!=e.dispatchUrl?e.webSocketPathDelimiter+e.dispatchUrl+e.webSocketPathDelimiter+a:a,p.canSendMessage?p.send(f):d.atmosphere.error("WebSocket not connected.")}catch(h){p.onclose=function(a){},q(),L("Websocket failed. Downgrading to Comet and resending "+c),Z(c)}}function ha(c){c=d.parseJSON(c);if(c.id!==H)if("undefined"!==typeof e.onLocalMessage)e.onLocalMessage(c.event);else if("undefined"!==typeof d.atmosphere.onLocalMessage)d.atmosphere.onLocalMessage(c.event)}
function I(c,a,e,d){f.responseBody=c;f.transport=d;f.status=e;f.state=a;x()}function Y(c,a){if(a.readResponsesHeaders)try{var e=c.getResponseHeader("X-Atmosphere-tracking-id");e&&null!=e&&(a.uuid=e.split(" ").pop())}catch(f){}else a.enableProtocol||(a.uuid=d.atmosphere.guid())}function ma(c){qa(c,e);qa(c,d.atmosphere)}function qa(c,a){switch(c.state){case "messageReceived":y=0;if("undefined"!==typeof a.onMessage)a.onMessage(c);break;case "error":if("undefined"!==typeof a.onError)a.onError(c);break;
case "opening":delete e.closed;if("undefined"!==typeof a.onOpen)a.onOpen(c);break;case "messagePublished":if("undefined"!==typeof a.onMessagePublished)a.onMessagePublished(c);break;case "re-connecting":if("undefined"!==typeof a.onReconnect)a.onReconnect(e,c);break;case "closedByClient":if("undefined"!==typeof a.onClientTimeout)a.onClientTimeout(e);break;case "re-opening":delete e.closed;if("undefined"!==typeof a.onReopen)a.onReopen(e,c);break;case "fail-to-reconnect":if("undefined"!==typeof a.onFailureToReconnect)a.onFailureToReconnect(e,
c);break;case "unsubscribe":case "closed":if(("undefined"===typeof e.closed||!e.closed)&&"undefined"!==typeof a.onClose)a.onClose(c);e.closed=!0}}function T(c){"closed"!==f.state&&(f.state="closed",f.responseBody="",f.messages=[],f.status=c?200:501,x())}function x(){var c=function(a,c){c(f)};null==w&&null!=R&&R(f.responseBody);e.reconnect=e.mrequest;for(var a="string"===typeof f.responseBody,g=a&&e.trackMessageLength?0<f.messages.length?f.messages:[""]:Array(f.responseBody),h=0;h<g.length;h++)if(!(1<
g.length&&0===g[h].length||(f.responseBody=a?d.trim(g[h]):g[h],null==w&&null!=R&&R(f.responseBody),(0===f.responseBody.length||a&&ea===f.responseBody)&&"messageReceived"===f.state))){ma(f);if(0<d.atmosphere.callbacks.length){"debug"===e.logLevel&&d.atmosphere.debug("Invoking "+d.atmosphere.callbacks.length+" global callbacks: "+f.state);try{d.each(d.atmosphere.callbacks,c)}catch(k){d.atmosphere.log(e.logLevel,["Callback exception"+k])}}if("function"===typeof e.callback){"debug"===e.logLevel&&d.atmosphere.debug("Invoking request callbacks");
try{e.callback(f)}catch(l){d.atmosphere.log(e.logLevel,["Callback exception"+l])}}}}function ka(c,a){return""===f.partialMessage&&"streaming"===a.transport&&c.responseText.length>a.maxStreamingLength?!0:!1}function fa(){if(e.enableProtocol&&!e.firstMessage){var c="X-Atmosphere-Transport=close&X-Atmosphere-tracking-id="+e.uuid;d.each(e.headers,function(a,g){var k=d.isFunction(g)?g.call(this,e,e,f):g;null!=k&&(c+="&"+encodeURIComponent(a)+"="+encodeURIComponent(k))});var a=e.url.replace(/([?&])_=[^&]*/,
c),a=a+(a===e.url?(/\?/.test(e.url)?"&":"?")+c:"");0<e.connectTimeout?d.ajax({url:a,async:e.closeAsync,timeout:e.connectTimeout,cache:!1,crossDomain:e.enableXDR}):d.ajax({url:a,async:e.closeAsync,cache:!1,crossDomain:e.enableXDR})}}function O(){e.reconnectId&&(clearTimeout(e.reconnectId),delete e.reconnectId);e.heartbeatTimer&&clearTimeout(e.heartbeatTimer);e.reconnect=!1;G=!0;f.request=e;f.state="unsubscribe";f.responseBody="";f.status=408;x();fa();q()}function q(){f.partialMessage="";e.id&&clearTimeout(e.id);
e.heartbeatTimer&&clearTimeout(e.heartbeatTimer);null!=C&&(C.close(),C=null);null!=v&&(v.abort(),v=null);null!=K&&(K.abort(),K=null);null!=p&&(p.canSendMessage&&p.close(),p=null);null!=z&&(z.close(),z=null);null!=D&&(clearInterval(X),document.cookie=ca+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",D.signal("close",{reason:"",heir:G?(D.get("children")||[])[0]:H}),D.close());null!=w&&w.close()}var e={timeout:3E5,method:"GET",headers:{},contentType:"",callback:null,url:"",data:"",suspend:!0,maxRequest:-1,
reconnect:!0,maxStreamingLength:1E7,lastIndex:0,logLevel:"info",requestCount:0,fallbackMethod:"GET",fallbackTransport:"streaming",transport:"long-polling",webSocketImpl:null,webSocketBinaryType:null,dispatchUrl:null,webSocketPathDelimiter:"@@",enableXDR:!1,rewriteURL:!1,attachHeadersAsQueryString:!0,executeCallbackBeforeReconnect:!1,readyState:0,withCredentials:!1,trackMessageLength:!1,messageDelimiter:"|",connectTimeout:-1,reconnectInterval:0,dropHeaders:!0,uuid:0,shared:!1,readResponsesHeaders:!1,
maxReconnectOnClose:5,enableProtocol:!0,pollingInterval:0,heartbeat:{client:null,server:null},ackInterval:0,closeAsync:!1,reconnectOnServerError:!0,onError:function(c){},onClose:function(c){},onOpen:function(c){},onMessage:function(c){},onReopen:function(c,a){},onReconnect:function(c,a){},onMessagePublished:function(c){},onTransportFailure:function(c,a){},onLocalMessage:function(c){},onFailureToReconnect:function(c,a){},onClientTimeout:function(c){}},f={status:200,reasonPhrase:"OK",responseBody:"",
messages:[],headers:[],state:"messageReceived",transport:"polling",error:null,request:null,partialMessage:"",errorHandled:!1,closedByClientTimeout:!1,ffTryingReconnect:!1},p=null,z=null,K=null,C=null,v=null,aa=!0,y=0,ea=" ",G=!1,R=null,D,w=null,H=d.now(),X,ca;l(k);this.subscribe=function(c){l(c);g()};this.execute=function(){g()};this.invokeCallback=function(){x()};this.close=function(){O()};this.disconnect=function(){fa()};this.getUrl=function(){return e.url};this.push=function(c,a){if(null!=a){var d=
e.dispatchUrl;e.dispatchUrl=a;Q(c);e.dispatchUrl=d}else Q(c)};this.getUUID=function(){return e.uuid};this.pushLocal=function(c){if(0!==c.length)try{w?w.localSend(c):D&&D.signal("localMessage",d.stringifyJSON({id:H,event:c}))}catch(a){d.atmosphere.error(a)}};this.enableProtocol=function(c){return e.enableProtocol};this.request=e;this.response=f},subscribe:function(k,l,g){"function"===typeof l&&d.atmosphere.addCallback(l);"string"!==typeof k?g=k:g.url=k;d.atmosphere.uuid="undefined"!==typeof g&&"undefined"!==
typeof g.uuid?g.uuid:0;k=new d.atmosphere.AtmosphereRequest(g);k.execute();return d.atmosphere.requests[d.atmosphere.requests.length]=k},addCallback:function(k){-1===d.inArray(k,d.atmosphere.callbacks)&&d.atmosphere.callbacks.push(k)},removeCallback:function(k){k=d.inArray(k,d.atmosphere.callbacks);-1!==k&&d.atmosphere.callbacks.splice(k,1)},unsubscribe:function(){if(0<d.atmosphere.requests.length)for(var k=[].concat(d.atmosphere.requests),l=0;l<k.length;l++){var g=k[l];g.close();clearTimeout(g.response.request.id);
g.heartbeatTimer&&clearTimeout(g.heartbeatTimer)}d.atmosphere.requests=[];d.atmosphere.callbacks=[]},unsubscribeUrl:function(k){var l=-1;if(0<d.atmosphere.requests.length)for(var g=0;g<d.atmosphere.requests.length;g++){var s=d.atmosphere.requests[g];if(s.getUrl()===k){s.close();clearTimeout(s.response.request.id);s.heartbeatTimer&&clearTimeout(s.heartbeatTimer);l=g;break}}0<=l&&d.atmosphere.requests.splice(l,1)},publish:function(k){"function"===typeof k.callback&&d.atmosphere.addCallback(k.callback);
k.transport="polling";k=new d.atmosphere.AtmosphereRequest(k);return d.atmosphere.requests[d.atmosphere.requests.length]=k},checkCORSSupport:function(){return d.browser.msie&&!window.XDomainRequest&&11>+d.browser.version.split(".")[0]||d.browser.opera&&12>+d.browser.version.split(".")[0]||"KreaTVWebKit/531"===d.trim(navigator.userAgent).slice(0,16)||"kreatel"===d.trim(navigator.userAgent).slice(-7).toLowerCase()?!0:-1<navigator.userAgent.toLowerCase().indexOf("android")?!0:!1},S4:function(){return(65536*
(1+Math.random())|0).toString(16).substring(1)},guid:function(){return d.atmosphere.S4()+d.atmosphere.S4()+"-"+d.atmosphere.S4()+"-"+d.atmosphere.S4()+"-"+d.atmosphere.S4()+"-"+d.atmosphere.S4()+d.atmosphere.S4()+d.atmosphere.S4()},prepareURL:function(k){var l=d.now(),g=k.replace(/([?&])_=[^&]*/,"$1_="+l);return g+(g===k?(/\?/.test(k)?"&":"?")+"_="+l:"")},param:function(k){return d.param(k,d.ajaxSettings.traditional)},supportStorage:function(){var k=window.localStorage;if(k)try{return k.setItem("t",
"t"),k.removeItem("t"),window.StorageEvent&&!d.browser.msie&&!(d.browser.mozilla&&"1"===d.browser.version.split(".")[0])}catch(l){}return!1},iterate:function(d,l){var g;l=l||0;(function P(){g=setTimeout(function(){!1!==d()&&P()},l)})();return function(){clearTimeout(g)}},log:function(d,l){if(window.console){var g=window.console[d];"function"===typeof g&&g.apply(window.console,l)}},warn:function(){d.atmosphere.log("warn",arguments)},info:function(){d.atmosphere.log("info",arguments)},debug:function(){d.atmosphere.log("debug",
arguments)},error:function(){d.atmosphere.log("error",arguments)},isBinary:function(d){return/^\[object\s(?:Blob|ArrayBuffer|.+Array)\]$/.test(Object.prototype.toString.call(d))}};(function(){var k,l;d.uaMatch=function(d){d=d.toLowerCase();d=/(chrome)[ \/]([\w.]+)/.exec(d)||/(webkit)[ \/]([\w.]+)/.exec(d)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(d)||/(msie) ([\w.]+)/.exec(d)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(d)||0>d.indexOf("compatible")&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(d)||[];return{browser:d[1]||
"",version:d[2]||"0"}};k=d.uaMatch(navigator.userAgent);l={};k.browser&&(l[k.browser]=!0,l.version=k.version);l.chrome?l.webkit=!0:l.webkit&&(l.safari=!0);l.trident&&(l.msie=!0);d.browser=l;d.sub=function(){function g(d,k){return new g.fn.init(d,k)}d.extend(!0,g,this);g.superclass=this;g.fn=g.prototype=this();g.fn.constructor=g;g.sub=this.sub;g.fn.init=function(l,m){m&&m instanceof d&&!(m instanceof g)&&(m=g(m));return d.fn.init.call(this,l,m,k)};g.fn.init.prototype=g.fn;var k=g(document);return g}})();
(function(d){function l(d){return'"'+d.replace(P,function(d){var g=m[d];return"string"===typeof g?g:"\\u"+("0000"+d.charCodeAt(0).toString(16)).slice(-4)})+'"'}function g(d){return 10>d?"0"+d:d}function s(d,k){var m,N,u,n=k[d];u=typeof n;n&&"object"===typeof n&&"function"===typeof n.toJSON&&(n=n.toJSON(d),u=typeof n);switch(u){case "string":return l(n);case "number":return isFinite(n)?String(n):"null";case "boolean":return String(n);case "object":if(!n)return"null";switch(Object.prototype.toString.call(n)){case "[object Date]":return isFinite(n.valueOf())?
'"'+n.getUTCFullYear()+"-"+g(n.getUTCMonth()+1)+"-"+g(n.getUTCDate())+"T"+g(n.getUTCHours())+":"+g(n.getUTCMinutes())+":"+g(n.getUTCSeconds())+'Z"':"null";case "[object Array]":N=n.length;u=[];for(m=0;m<N;m++)u.push(s(m,n)||"null");return"["+u.join(",")+"]";default:u=[];for(m in n)Object.prototype.hasOwnProperty.call(n,m)&&(N=s(m,n))&&u.push(l(m)+":"+N);return"{"+u.join(",")+"}"}}}var P=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
m={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};d.stringifyJSON=function(d){return window.JSON&&window.JSON.stringify?window.JSON.stringify(d):s("",{"":d})}})(d)});